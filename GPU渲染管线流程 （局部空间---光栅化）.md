# GPU渲染管线流程 （局部空间--->光栅化）

## 1.顶点shader

##### 1.主要内容：对输入的每个顶点进行坐标系变换操作,即对顶点坐标进行空间变换，模拟“拍照”即投影成像的过程，对3维对象进行变形

##### 2.空间（顶点坐标系）变换：局部空间->世界空间->相机空间->裁剪空间

- **step1** **放置物体**——局部空间通过模型矩阵变换为世界空间，顶点数据从模型坐标系转换为世界坐标系

  - 1. **模型空间**：

       以该模型的几何中心作为空间坐标原点，当模型旋转或移动，模型空间也会随之移动。

  - 1. **模型矩阵作用**：

       通过应用模型矩阵，对模型进行移动，旋转，缩放变换，是模型以特定角度，大小，位置放置在世界空间中 。

    2. **模型矩阵目的**：

       将模型变换到合适的渲染空间当中。

- **step2** **摆好相机**——世界空间通过视图矩阵变换为相机空间，顶点数据从世界坐标系转换为相机坐标系

  - 1. **世界空间**:

       其坐标系是指将整个世界包裹起来的坐标系，即所有物体公有的一套坐标系。当模型旋转或移动，世界空间不会随之移动。

  - 1. **视图矩阵的作用**：

       为了得到2维图像，即相机所看到的图像，又想计算方便，便把相机移动到原点并且看向-z轴，头顶着y轴，x指向相机的右方。以上包含移动，旋转的变换是通过对视图矩阵的应用而来。

       ps.（接着对所有其他模型应用视图矩阵。这样可以让相机和模型们都是相对静止的。相机所看到的内容，跟view变换之前的没有任何区别。但从世界空间看，相机和模型的绝对位置和朝向其实都变了）

    2. **视图矩阵目的**：

       将相机放置于坐标原点,方便后续操作。

- **step3** **摁下快门**——相机空间通过投影矩阵变换为裁剪空间，顶点数据从相机坐标系转换为裁剪坐标系

  - 1. **相机空间**：

       以相机为原点，相机前方为-z、头顶y、右x的坐标空间便为相机空间，相机空间决定了渲染使用的视角。

  - 1. **视图矩阵的作用**：

       由于相机有一定可视范围（视锥体），我们需要对3维对象进行裁剪。但用视锥体的6个裁剪平面来进行裁剪会比较麻烦。而通过投影矩阵对顶点x,y,z分量进行缩放变换，得到顶点w分量。之后的裁剪操作便以w分量作为阈值，判断顶点是否位于裁剪空间。

       ps(投影矩阵变换:就是将棱锥无限切分，然后全部缩放成近平面的大小。最后，将缩放后的长方体再平移缩放到标准立方体中)

    2. **视图矩阵的目的**：

       方便裁剪。而裁剪空间能够方便地对渲染图元进行裁剪（裁剪空间具体原点性质母鸡，看图猜测还是以相机为原点，z轴方向相反）

## 2.裁剪操作

- 1. **主要内容**：是为了将相机视图之外的顶点剔除出去，即任何超出视锥体的顶点都会被舍弃
  2. **具体操作**：如果顶点在视椎体内，则它的x，y，z分量值域为[-w,w]。如果有任何一个分量绝对值超过w，则这个顶点会被裁剪不会在屏幕中出现。完全位于这块空间内部的顶点将会被保留，完全位于这块空间外部的顶点将会被剔除，而与这块空间边界相交的顶点就会被裁剪。

## 3.透视除法(分割)

- 1. 通过**透视除法**，即顶点三个分量都除以w分量，裁剪空间转换到 **标准化设备空间NDC**，所有的坐标归一化，落在[-1,1]的范围内，顶点数据从裁剪坐标系转换为**NDC标准化设备坐标**。

## 4.背面剔除

- 1.物体的背面是不需要绘制的，我们因此可以将朝向视线方向的平面都剔除掉。
- 2.如果没有开启剔除，则可能有很多从一般常识上看来是看不见的那一面（比如几何体内部），也会 被进行渲染。这显然会**大大降低渲染效率和增加不必要的系统开销**。因此剔除操作抛弃背向观察者的三角形，以避免GPU去光栅化不可见的三角形，提升应用程序的整体性能，执行效率。

## 5.视口转换（**屏幕映射**）

- 1.**主要目的**：将裁剪空间转换到屏幕空间， 即把裁剪空间投影（平面化）到屏幕空间（二维空间）中。

- 2.**方式**：应用**视口变换矩阵**把这些位于[-1,1]范围内的所有顶点平移、缩放到屏幕空间中

- 3.**屏幕空间**：就是 以（0，0）为原点，y轴上为正，x轴右为正的坐标系中。

  ps.坐标范围就是显示器的分辨率大小

## 6.图元装配

- 1 。根据伴随顶点序列的集合图元分类信息把顶点装配几何图元。产生一系列的三角形，线段和点。
- 2.（网上资料有的认为以上4步包含在图元装配中）

## 7.光栅化

#### 简单定义和作用：

是把顶点数据转换为片元的过程，具有将图转化为一个个栅格组成的图象的作用。

#### 1.三角形设置（图元组装）

- 1.**主要内容**：将输入的顶点组装成指定的图元,即依据顶点的数据和信息，将需要连接的顶点连线，组成一个个面。
- 2.**详细定义分析**：上一个阶段输出的都是三角网格的顶点，即得到的是三角网格每条边的两个端点。但如果要得到整个三角网格对像素的覆盖情况，就必须计算每条边上的像素坐标。为了能够计算边界像素的坐标信息，就需要得到三角形边界的表示方式。这样一个计算三角网格表示数据的过程就叫做三角形设置。
- ps:
- 顶点不一定会连线，单个顶点，或者顶点的连线，也可作为图元，图元不一定是一个面。
- 图元组装阶段会进行裁剪和背面剔除相关的优化，以减少进入光栅化的图元的数量，加速渲染过程。
- 因为任意多边形都可以分为多个三角形，所以三角形为基本图元。

#### 2.三角形遍历

- 1.**主要内容**：将变换到屏幕空间的图元离散化为片元的过程，输出一个片元序列。
- 2.**具体操作**：
  - step1——根据上一个阶段的计算结果来判断一个三角网格覆盖了哪些像素。
  - step2——检查每个像素是否被一个三角形网格所覆盖。
  - step3——如果屏幕上某个像素点被判断为被图元覆盖，则会生成对应像素大小的片元。